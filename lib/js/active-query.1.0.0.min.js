var Query={},data_query={};Query.utility=function(){function a(a,b){return"timeofday"===b.type?a.v[0]+":"+a.v[1]+":"+a.v[2]+"."+a.v[3]:a.v}var b=function(b,c){var d=[];switch(c){case"GQL":var e,f,g,h,i,j,k,l=[],m=b.Ff.length;for(f=0;m>f;f++)l.push(b.Ff[f].label);for(g=b.Gf,h=g.length,e=l.length,k=0;h>k;k++){for(i=g[k].c,j={},p=0;p<e;p++)j[l[p]]=i[p]?a(i[p],b.Ff[p]):null;d.push(j)}}return d},c=function(a){var b,c=[{},{}];switch(data_query[a.table[0]].filter_dimension.filterAll(),data_query[a.table[1]].filter_dimension.filterAll(),c[0].data=JSON.parse(JSON.stringify(data_query[a.table[0]].filter_dimension.top(1/0))),c[1].data=JSON.parse(JSON.stringify(data_query[a.table[1]].filter_dimension.top(1/0))),c[0].joinByColumn=a.on[0],c[1].joinByColumn=a.on[1],a.type){case"fulljoin":b=e(c)}return b},d=function(b,c,d,e,f,g){var h,i,j,k,l,m,n,o,p,q,r,s,t=[],u=[],v=b.Gf,w=v.length,x=c.length,y=e.length,z=b.Ff.length-x,A=[],B=[],C=[],D=[],E=[],F=[];for(t.push.apply(t,c),t.push.apply(t,e),t.push(g),k=t.length,f&&w--,d&&z--,o=0;x>o;o++)for(A[o]=[],h=0;w>h;h++)""!==v[h].c[o].v&&(A[o][A[o].length-1]&&A[o][A[o].length-1][0]+" Total"===v[h].c[o].v?C.push(h):A[o].push([v[h].c[o].v,h]));for(o=0;y>o;o++)B[o]=[];for(i=0;z>i;i++){for(n=D.length,o=0;y-1>o;o++)!B[o][B[o].length-1]||b.Ff[i+x].label!==B[o][B[o].length-1][0]+" Total "&&b.Ff[i+x].label!==B[o][B[o].length-1][0]+" Total"||D.push(i);if(D.length===n)if(p=b.Ff[i+x].label.split(" "),q=p.length,1===q)B[y-1].push([p[0],i]);else for(o=q-1;o>=0;o--)B[y-1-(q-1-o)].push([p[o],i])}for(o=0;y>o;o++)F.push(0);for(o=0;x>o;o++)E.push(0);for(h=0;w>h;h++)if(l=v[h].c,!(C.indexOf(h)>-1)){for(o=0;y>o;o++)F[o]=0;for(i=0;z>i;i++)if(!(D.indexOf(i)>-1)){for(m={},j=0;k>j;j++)r=c.indexOf(t[j]),s=e.indexOf(t[j]),r>-1?r!==y-1?(A[r][E[r]+1]&&h===A[r][E[r]+1][1]&&E[r]++,m[t[j]]=A[r][E[r]][0]):m[t[j]]=l[r]?a(l[r],b.Ff[r]):null:s>-1?s!==y-1?(B[s][F[s]+1]&&i===B[s][F[s]+1][1]&&F[s]++,m[t[j]]=B[s][F[s]][0]):m[t[j]]=B[s][F[s]][0]:m[t[j]]=l[i+x]?a(l[i+x],b.Ff[i+x]):null;u.push(m),F[F.length-1]++}E[E.length-1]++}return u},e=function(a){var b,c,d,e,g,h,i,j,k,l,m=[],n=[],o=[],p=a[0].data,q=a[1].data,r={},s={},t=!0;q.length<p.length?(n=q,o=p,b=a[1].joinByColumn,c=a[0].joinByColumn):(n=p,o=q,b=a[0].joinByColumn,c=a[1].joinByColumn);for(i in n[0])r[i]="null";for(j in o[0])s[j]="null";for(d=0;d<o.length;d++){for(t=!1,e=0;e<n.length;e++)o[d][b]===n[e][c]&&(m.push(f(o[d],n[e])),n.splice(e,1),e--,t=!0);t||(k=Object.assign({},r),m.push(f(r,o[d])),r=k,o.splice(d,1),d--)}for(h=n.length,g=0;h>g;g++)l=Object.assign({},s),m.push(f(s,n[g])),s=l;return m},f=function(a,b){var c=a,d=a.length;return void 0===d&&"number"!=typeof a?$.each(b,function(d,e){void 0===a[d]?c[d]=e:c[d]=f(a[d],b[d])}):d>0&&"string"!=typeof a?$.each(b,function(d){-1===JSON.stringify(a).indexOf(JSON.stringify(b[d]))&&c.push(b[d])}):c=b,c},g=function(a){var b,c=data_query[a].config;return b=c.join?c.join.table[0]+"_"+c.join.type+"_"+c.join.table[1]:c.from};return{convertDataToJson:b,joinDataSet:c,getTableName:g,unPivotDataSet:d}}(),Query.dataProcessing=function(){var a=function(a,c,d){if(c.join){if(2!==data_query[c.join.table[0]].status||2!==data_query[c.join.table[1]].status)return}else if(2!==data_query[c.from].status)return;var e,f,g,h=data_query[c.from].config.adapter;switch(c.filter_impacts&&b(a,c.filter),h){case"InBrowser":c.join?(e=c.join.table[0]+"_"+c.join.type+"_"+c.join.table[1],data_query[e]||(f=Query.utility.joinDataSet(c.join),ActiveQuery.createTable(e,"InBrowser",f))):e=c.from,Query.inBrowser.setQuery(e,a,c),g=Query.inBrowser.getData(e,a);break;case"GQL":if("function"!=typeof d&&console.warn("GQL adapter queries are async.You can pass a callback function in Exec() that accepts data as a param."),c.join){var i=new google.visualization.Query("https://docs.google.com/spreadsheets/d/"+data_query[c.join.table[0]].config.sheet+"/gviz/tq?gid="+data_query[c.join.table[0]].config.sheetId),j=[[]],k=[],l=[];i.setQuery("select *"),i.send(function(b){for(var h=b.getDataTable(),m=(new google.visualization.Query("https://docs.google.com/spreadsheets/d/"+data_query[c.join.table[1]].config.sheet+"/gviz/tq?gid="+data_query[c.join.table[1]].config.sheetId),0);m<h.Ff.length;m++)h.Ff[m].label===c.join.on[0]?j[0].push(m):k.push(m);i.setQuery("select *"),i.send(function(b){for(var i=b.getDataTable(),m=0;m<i.Ff.length;m++)h.Ff[m].label===c.join.on[1]?j[0].push(m):l.push(m);"fulljoin"===c.join.type&&(f=google.visualization.data.join(h,i,"full",j,k,l),e=c.join.table[0]+"_fulljoin_"+c.join.table[1],f=Query.utility.convertDataToJson(f,"GQL"),ActiveQuery.createTable(e,"InBrowser",f),Query.inBrowser.setQuery(e,a,c),g=Query.inBrowser.getData(e,a),d(g))})})}else{var m=Query.gql,n=m.moduleForProcessingJson(c);n=m.changeToGqlJson(data_query[c.from].config,n),m.getData(c.from,n,d)}}return g},b=function(a,c){var d,e,f=data_query[a].config.filter_impacts;if(f)for(d=f.length,e=0;d>e;e++)data_query[f[e]].config.filter?(data_query[f[e]].config.filter[data_query[f[e]].config.filter.length-1].nxt="And",data_query[f[e]].config.filter.push.apply(data_query[f[e]].config.filter,c)):data_query[f[e]].config.filter=c,b(f[e],c)};return{queryProcessor:a,filterPropagation:b}}(),ActiveQuery=function(){var a=function(a,b,c){data_query[a]={config:{tab_name:a,adapter:b,queries:[]},status:0,onComplete:[]},"InBrowser"===b?c instanceof Array&&0!==c.length&&"string"==typeof a?(Query.inBrowser.init(a,c),data_query[a].status+=2):console.warn("Improper data format for "+a):"GQL"===b&&(data_query[a].config.sheet=c.sheet,data_query[a].config.sheetNumber=c.sheetNumber,data_query[a].config.sheetId=c.sheetId,data_query[a].config.refresh_token=c.refresh_token,Query.gql.reGenerateAccessToken(data_query[a].config,function(a,b){b.access_token=a.access_token,data_query[b.tab_name].status++;var c=new google.visualization.Query("https://docs.google.com/spreadsheets/d/"+data_query[b.tab_name].config.sheet+"/gviz/tq?gid="+data_query[b.tab_name].config.sheetId);c.setQuery("select *"),c.send(function(a){data_query[b.tab_name].config.column_header=JSON.parse(JSON.stringify(a.getDataTable().Ff)),data_query[b.tab_name].status++;var c,d=data_query[b.tab_name].onComplete,e=d.length;if(e)for(c=0;e>c;c++)d[c].function_name.apply(this,d[c].attribute)})}),setInterval(function(){Query.gql.reGenerateAccessToken(data_query[a].config,function(a,b){b.access_token=a.access_token})},3e6))},b=function(a){data_query[a]={config:{status:!0}};var b={Select:function(){var b,c,d=arguments.length;if(data_query[a]&&data_query[a].config&&data_query[a].config.dim&&(data_query[a].config.dim=[]),0===d)data_query[a].config.dim=["*"];else for(data_query[a].config.dim=[],data_query[a].config.met=[],b=0;d>b;b++)"string"==typeof arguments[b]?(c=arguments[b].split(" AS "),1===c.length?data_query[a].config.dim.push(arguments[b]):c.length>1&&""!==c[1]?(data_query[a].config.as=data_query[a].config.as||{actual:[],alias:[]},data_query[a].config.as.actual.push(c[0]),data_query[a].config.as.alias.push(c[1]),data_query[a].config.dim.push(arguments[b])):console.warn("Invalid parameter.Give a new column name with AS.E.g. 'quantity AS QTY'")):"object"==typeof arguments[b]?"function"==typeof arguments[b][Object.keys(arguments[b])[0]]?data_query[a].config.dim.push(arguments[b]):data_query[a].config.met.push(arguments[b]):(console.warn("Invalid property values"),data_query[a].config={});return this},From:function(b){return"string"==typeof b&&data_query[b]?(data_query[a].config.from=b,data_query[b]&&data_query[b].config&&-1===data_query[b].config.queries.indexOf(a)&&data_query[b].config.queries.push(a)):(console.warn("Invalid table name"),data_query[a].config={}),this},Where:function(b){return data_query[a].config.filter=[],"string"==typeof b?0===data_query[a].config.filter.length?data_query[a].config.filter.push({col_name:b}):data_query[a].config.filter[data_query[a].config.filter.length-1].col_name=b:"function"==typeof b?0===data_query[a].config.filter.length?data_query[a].config.filter.push({cond:"Eval",val:value}):(data_query[a].config.filter[data_query[a].config.filter.length-1].cond="Eval",data_query[a].config.filter[data_query[a].config.filter.length-1].val=value):0===arguments.length?console.warn("Where accepts column name as a string parameter"):(console.warn("Invalid condition"),data_query[a].config={}),this},OrderBy:function(b,c){return"string"!=typeof b?(console.warn("Invalid column name"),data_query[a].config={}):(data_query[a].config.sort={},void 0===c||"asc"===c?data_query[a].config.sort.asc=b:"desc"===c?data_query[a].config.sort.desc=b:console.warn("Invalid order type.Please enter 'asc' or 'desc'")),this},Group:function(){return 0===arguments.length?0===data_query[a].config.dim.length&&0!==Object.keys(data_query[a].config.met).length?(console.warn("group cannot work only on met"),data_query[a].config={}):data_query[a].config.group=!0:(console.warn("Please do not enter any arguments to group"),data_query[a].config={}),this},Equal:function(b){return"string"==typeof b||"number"==typeof b?(data_query[a].config.filter[data_query[a].config.filter.length-1].cond="Equal",data_query[a].config.filter[data_query[a].config.filter.length-1].val=b):(console.warn("Invalid value"),data_query[a].config={}),this},NotEqual:function(b){return"string"==typeof b||"number"==typeof b?(data_query[a].config.filter[data_query[a].config.filter.length-1].cond="NotEqual",data_query[a].config.filter[data_query[a].config.filter.length-1].val=b):(console.warn("Invalid value"),data_query[a].config={}),this},LessThan:function(b){return"string"==typeof b||"number"==typeof b?(data_query[a].config.filter[data_query[a].config.filter.length-1].cond="LessThan",data_query[a].config.filter[data_query[a].config.filter.length-1].val=b):(console.warn("Invalid value"),data_query[a].config={}),this},GreaterThan:function(b){return"string"==typeof b||"number"==typeof b?(data_query[a].config.filter[data_query[a].config.filter.length-1].cond="GreaterThan",data_query[a].config.filter[data_query[a].config.filter.length-1].val=b):(console.warn("Invalid value"),data_query[a].config={}),this},LessThanEqual:function(b){return"string"==typeof b||"number"==typeof b?(data_query[a].config.filter[data_query[a].config.filter.length-1].cond="LessThanEqual",data_query[a].config.filter[data_query[a].config.filter.length-1].val=b):(console.warn("Invalid value"),data_query[a].config={}),this},GreaterThanEqual:function(b){return"string"==typeof b||"number"==typeof b?(data_query[a].config.filter[data_query[a].config.filter.length-1].cond="GreaterThanEqual",data_query[a].config.filter[data_query[a].config.filter.length-1].val=b):(console.warn("Invalid value"),data_query[a].config={}),this},Between:function(b){return b instanceof Array?(data_query[a].config.filter[data_query[a].config.filter.length-1].cond="Between",data_query[a].config.filter[data_query[a].config.filter.length-1].val=b):(console.warn("Invalid range"),data_query[a].config={}),this},NotBetween:function(b){return b instanceof Array?(data_query[a].config.filter[data_query[a].config.filter.length-1].cond="NotBetween",data_query[a].config.filter[data_query[a].config.filter.length-1].val=b):(console.warn("Invalid range"),data_query[a].config={}),this},In:function(b){return b instanceof Array?(data_query[a].config.filter[data_query[a].config.filter.length-1].cond="In",data_query[a].config.filter[data_query[a].config.filter.length-1].val=b):(console.warn("Invalid values"),data_query[a].config={}),this},NotIn:function(b){return b instanceof Array?(data_query[a].config.filter[data_query[a].config.filter.length-1].cond="NotIn",data_query[a].config.filter[data_query[a].config.filter.length-1].val=b):(console.warn("Invalid values"),data_query[a].config={}),this},IsNull:function(){return 0===arguments.length?data_query[a].config.filter[data_query[a].config.filter.length-1].cond="IsNull":(console.warn("IsNull does not take any input parameter"),data_query[a].config={}),this},IsNotNull:function(){return 0===arguments.length?data_query[a].config.filter[data_query[a].config.filter.length-1].cond="IsNotNull":(console.warn("IsNotNull does not take any input parameter"),data_query[a].config={}),this},And:function(b){return"string"==typeof b?(data_query[a].config.filter.push({col_name:b}),data_query[a].config.filter[data_query[a].config.filter.length-2].nxt="And"):(console.warn("Invalid column name"),data_query[a].config={}),this},Or:function(b){return"string"==typeof b?(data_query[a].config.filter.push({col_name:b}),data_query[a].config.filter[data_query[a].config.filter.length-2].nxt="Or"):(console.warn("Invalid column name"),data_query[a].config={}),this},Limit:function(b){return"number"==typeof b?data_query[a].config.limit=b:(console.warn("Invalid argument"),data_query[a].config={}),this},FullJoin:function(b){return"string"==typeof b&&data_query[b]?(data_query[a].config.join={},data_query[a].config.join.type="fulljoin",data_query[a].config.join.table=[data_query[a].config.from,b]):(console.warn("Invalid table name"),data_query[a].config={}),this},On:function(b,c){return"string"==typeof b&&"string"==typeof c?data_query[a].config.join.on=[b,c]:(console.warn("Invalid column names"),data_query[a].config={}),this},Pivot:function(){var b=Query.utility.getTableName(a);return"GQL"===data_query[b].config.adapter?arguments.length>0?data_query[a].config.pivot=arguments:console.warn("Pivot needs atleast 1 column name as an argument"):console.warn("Pivot is only supported in GQL adapter"),this},Exec:function(b){var c;if((data_query[a].config.group===!1||void 0===data_query[a].config.group)&&data_query[a].config.dim&&0!==data_query[a].config.dim.length&&data_query[a].config.met&&0!==data_query[a].config.met.length?(console.warn("Both dimension and metric cannot work together without group."),data_query[a].config={}):data_query[a].config.dim&&0!==data_query[a].config.dim.length&&data_query[a].config.met&&0!==data_query[a].config.met.length&&data_query[a].config.dim.length>1&&data_query[a].config.met.length>1&&(console.warn("There can be 1 dimension and 1 metric per query if together"),data_query[a].config={}),data_query[a].config.status){var d=data_query[a].config;if(2===data_query[d.from].status&&(d.join&&d.join.length?2===data_query[d.join.table[1]].config.status:!0))return c=Query.dataProcessing.queryProcessor(a,data_query[a].config,b);data_query[d.from].onComplete.push({function_name:Query.dataProcessing.queryProcessor,attribute:[a,data_query[a].config,b]}),d.join&&d.join.length&&data_query[d.join.table[1]].onComplete.push({function_name:Query.dataProcessing.queryProcessor,attribute:[a,data_query[a].config,b]})}},AddDataPropagation:function(b){var c,d=arguments.length;if(0===d)console.warn("AddDataPropagation accepts table names as string parameters");else for(data_query[a].config.data_impacts=data_query[a].config.data_impacts||[],c=0;d>c;c++)"string"==typeof arguments[c]&&data_query[arguments[c]]?data_query[a].config.data_impacts.push(arguments[c]):(console.warn("Invalid table name "+arguments[c]),data_query[a].config.status=!1,data_query[a].config={});return this},AddFilterPropagation:function(b){var c,d=arguments.length;if(0===d)console.warn("AddDataPropagation accepts table names as string parameters");else for(data_query[a].config.filter_impacts=data_query[a].config.filter_impacts||[],c=0;d>c;c++)"string"==typeof arguments[c]&&data_query[arguments[c]]?data_query[a].config.filter_impacts.push(arguments[c]):(console.warn("Invalid query name "+arguments[c]),data_query[a].config.status=!1,data_query[a].config={});return this}};return b},c=function(a,b,c,d){var e=data_query[a].config.adapter;"InBrowser"===e?b instanceof Array&&0!==b.length&&"string"==typeof a?(data_query[a].filter_dimension.filterAll(),data_query[a].cf.remove(),data_query[a].cf.add(b)):console.warn("Improper data format for "+a):console.warn("updateData can be executed only on InBrowser and GQL adapter tables")},d=function(a,b,c,d){var e=data_query[a].config.adapter;"InBrowser"===e?b instanceof Array&&0!==b.length&&"string"==typeof a?data_query[a].cf.add(b):console.warn("Improper data format for "+a):data_query[a].config?console.warn("addData can be executed only on InBrowser and GQL adapter"):console.warn("Invalid table name")},e=function(a){try{if(data_query[a]){data_query[a][a+"_dimension_"]&&(data_query[a][a+"_dimension_"].remove(),data_query[a][a+"_dimension_"].dispose(),delete data_query[a][a+"_dimension_"]),data_query[a][a+"_metric_"]&&(data_query[a][a+"_metric_"].remove(),data_query[a][a+"_metric_"].dispose(),delete data_query[a][a+"_metric_"]);var b;b=data_query[a].config.join?data_query[a].config.join.table[0]+"_"+data_query[a].config.join.type+"_"+data_query[a].config.join.table[1]:data_query[a].config.from;var c=data_query[b].config.queries.indexOf(a);-1!==c&&data_query[b].config.queries.splice(c,1),delete data_query[a]}else console.error("Query "+a+" does not Exist")}catch(d){console.error("Error in query name")}},f=function(a){if(2===data_query[a].status){var b,c,d=data_query[a].queries;if(d)for(c=d.length,b=0;c>b;b++)e(d[b]);delete data_query[a]}else data_query[a].onComplete.push({function_name:f,attribute:[a,cascade_delete]})},g=function(a,b,c,d,e,f){if("GQL"===data_query[a].config.adapter){var g=new google.visualization.Query("https://docs.google.com/spreadsheets/d/"+data_query[a].config.sheet+"/gviz/tq?gid="+data_query[a].config.sheetId);g.setQuery("select *"),g.send(function(g){var h=Query.utility.unPivotDataSet(g.getDataTable(),b,c,d,e,f);ActiveQuery.createTable(a,"InBrowser",h)})}else console.warn("unPivotTable works only on tables in the GQL adapter")};return{createTable:a,createQuery:b,deleteTable:f,deleteQuery:e,updateData:c,addData:d,unPivotTable:g}}(),Query.inBrowser=function(){var a=function(a,b){data_query[a].cf=crossfilter(b),data_query[a].filter_dimension=data_query[a].cf.dimension(function(a){return a})},b=function(a,b,c){var d,e,h,i,j,k,l,m,n=data_query[b].config.data_impacts;for(k=0;k<n.length&&n[k]!==a;k++){for(d=n[k],e=data_query[d].config.queries,h=e.length,l=0;h>l;l++)for(i=Object.keys(data_query[e[l]]),j=i.length,m=0;j>m;m++)i[m].match("_dimension_")?(data_query[e[l]][i[m]].filterAll(),data_query[e[l]][i[m]].remove(),data_query[e[l]][i[m]].dispose(),delete data_query[e[l]][i[m]]):i[m].match("_metric_")&&(data_query[e[l]][i[m]].remove(),data_query[e[l]][i[m]].dispose(),delete data_query[e[l]][i[m]]);for(data_query[d].cf.remove(),data_query[d].cf.add(c),l=0;h>l;l++)f(d,e[l],data_query[e[l]].config),data_query[e[l]].config.data_impacts&&g(d,e[l])}},c=function(a,b,c){var d=data_query[a];data_query[b].custom_internal_dimension_||(data_query[b].custom_internal_dimension_=d.cf.dimension(function(a){return"a"})),data_query[b][b+"_dimension_"]=d.cf.dimension(function(a){var b,d,e,f,g="",h="|+|",i=c.length;for(e=0;i>e;e++)0===e&&(h=""),"object"==typeof c[e]?(f=Object.keys(c[e])[0],d=c[e][f]):d="*"===c[e]?Object.keys(a)[0]:c[e],b="function"==typeof d?f:d,"function"==typeof d?g=d(a):""===h&&1===i?g=a[d]:g+=a[d]+h;return g})},d=function(a,b,d){data_query[b].config.met||(data_query[b].config.met=d.met,d=d.met);var e,f,g,h,i,j=(data_query[a],d.length);for(e=0;j>e;e++){f=Object.keys(d[e])[0],data_query[b].hasOwnProperty(b+"_dimension_")||c(a,b,[f]),g=f,h=d[e][f],i=i?"1e-"+i:"1e-2";var k=function(a){return"function"==typeof h?h(a):+a[g]},l=function(a,b){var c=isNaN(+b[g])?0:+b[g];switch(h){case"count":return a+1;case"sum":return a+=parseFloat(c),+i>a&&(a=0),a;case"min":return"a"===a&&(a=+c),a=+c>a?a:+c;case"max":return"a"===a&&(a=+c),a=a>+c?a:+c;case"median":a.arr.push(+c),a.arr.sort(function(a,b){return a-b});var d=Math.floor(a.arr.length/2);return a.arr.length%2?(a.val=a.arr[d],a):(a.val=(a.arr[d-1]+a.arr[d])/2,a);case"avg":return++a.count,a.sum+=+c,a.val=a.sum/a.count,a.sum<=0&&(a.val=0),a;case"value":return a.val=c,a;case"std":a.arr.push(+c),++a.count,a.sum+=+c,a.mean=a.sum/a.count;var e,f=0,j=a.count;for(e=0;j>e;e++)f+=Math.pow(a.arr[e]-a.mean,2);return a.variance=f/a.count,a.std=Math.sqrt(a.variance),a;default:return k(b)}},m=function(a,b){var c=isNaN(+b[g])?0:+b[g];switch(h){case"count":return a-1;case"sum":return a-=parseFloat(c),+i>a&&(a=0),a;case"min":return"a"===a&&(a=+c),a=+c>a?a:+c;case"max":return"a"===a&&(a=+c),a=a>+c?a:+c;case"mean":break;case"median":a.arr.push(+c),a.arr.sort(function(a,b){return a-b});var d=Math.floor(a.arr.length/2);return a.arr.length%2?(a.val=a.arr[d],a):(a.val=(a.arr[d-1]+a.arr[d])/2,a);case"avg":return a.sum-=+c,--a.count,a.val=a.sum/a.count,a.sum<=0&&(a.val=0),a;case"value":return a.val=c,a;case"std":a.arr.push(+c),++a.count,a.sum-=+c,a.mean=a.sum/a.count;var e,f=0,j=a.count;for(e=0;j>e;e++)f+=Math.pow(a.arr[e]-a.mean,2);return a.variance=f*a.count,a.std=Math.sqrt(a.variance),a;default:return k(b)}},n=function(){switch(h){case"count":return 0;case"sum":return 0;case"min":return"a";case"max":return"a";case"mean":break;case"median":return{val:0,arr:[]};case"avg":return{count:0,sum:0,val:0};case"value":return{val:0};case"std":return{mean:0,variance:0,deviation:0,sum:0,count:0,arr:[]};default:return 0}};data_query[b].config.dim?data_query[b][b+"_metric_"]=data_query[b][b+"_dimension_"].group().reduce(l,m,n):data_query[b][b+"_metric_"]=data_query[b].custom_internal_dimension_.group().reduce(l,m,n)}},e=function(a,b,c){var d,e,f,g,h,i,j=c.length,k=!1,l="return ";for(d=0;j>d;d++){switch(c[d].cond){case"Equal":h="string"==typeof c[d].val?'"'+c[d].val+'"':c[d].val,l+='d["'+c[d].col_name+'"]  == '+h;break;case"NotEqual":h="string"==typeof c[d].val?'"'+c[d].val+'"':c[d].val,l+='d["'+c[d].col_name+'"]  != '+h;break;case"LessThan":h="string"==typeof c[d].val?'"'+c[d].val+'"':c[d].val,l+='d["'+c[d].col_name+'"]  < '+h;break;case"GreaterThan":h="string"==typeof c[d].val?'"'+c[d].val+'"':c[d].val,l+='d["'+c[d].col_name+'"]  > '+h;break;case"LessThanEqual":h="string"==typeof c[d].val?'"'+c[d].val+'"':c[d].val,l+='d["'+c[d].col_name+'"]  <= '+h;break;case"GreaterThanEqual":h="string"==typeof c[d].val?'"'+c[d].val+'"':c[d].val,l+='d["'+c[d].col_name+'"]  >= '+h;break;case"Between":h=["string"==typeof c[d].val[0]?'"'+c[d].val[0]+'"':c[d].val[0],"string"==typeof c[d].val[1]?'"'+c[d].val[1]+'"':c[d].val[1]],l+='(d["'+c[d].col_name+'"]  >= '+h[0]+' && d["'+c[d].col_name+'"] <= '+h[1]+")";break;case"NotBetween":h=["string"==typeof c[d].val[0]?'"'+c[d].val[0]+'"':c[d].val[0],"string"==typeof c[d].val[1]?'"'+c[d].val[1]+'"':c[d].val[1]],l+='(d["'+c[d].col_name+'"]  < '+h[0]+' || d["'+c[d].col_name+'"] > '+h[1]+")";break;case"In":for(e="",i=0;i<c[d].val.length;i++)e+="string"==typeof c[d].val[i]?'"'+c[d].val[i]+'"':c[d].val[i],i<c[d].val.length-1&&(e+=",");l+="["+e+'].indexOf(d["'+c[d].col_name+'"]) != -1';break;case"NotIn":for(e="",i=0;i<c[d].val.length;i++)e+="string"==typeof c[d].val[i]?'"'+c[d].val[i]+'"':c[d].val[i],i<c[d].val.length-1&&(e+=",");l+="["+e+'].indexOf(d["'+c[d].col_name+'"]) == -1';break;case"IsNull":l+='(d["'+c[d].col_name+'"]  === undefined || d["'+c[d].col_name+'"] === null || d["'+c[d].col_name+'"] == "null")';break;case"IsNotNull":l+='(d["'+c[d].col_name+'"]  !== undefined && d["'+c[d].col_name+'"] !== null || d["'+c[d].col_name+'"] != "null")';break;case"Eval":g=c[d].val,k=!0}l+=c[d].nxt?"And"===c[d].nxt?" && ":" || ":";"}f=k?g:new Function("d",l),data_query[a].filter_dimension.filterAll(),data_query[a].filter_dimension.filter(f)},f=function(a,b,f){data_query[b]={config:f},data_query[b].config.dim&&c(a,b,data_query[b].config.dim),data_query[b].config.filter&&e(a,b,data_query[b].config.filter),data_query[b].config.met&&d(a,b,data_query[b].config.met)},g=function(a,c){var d,e,f,g,h,i,j,k,l,m,n,o={};try{data_query[c].config.sort&&(e=Object.keys(data_query[c].config.sort)[0],f=data_query[c].config.sort[e])}catch(p){console.error("Sort syntax is not proper")}if(!data_query[c])return!1;data_query[c].config.met&&data_query[c].config.met.length>0?(o=data_query[c].config.met[0],j=Object.keys(data_query[c].config.met[0])[0],d=c+"_metric_"):d=data_query[c].config.dim?c+"_dimension_":c+"_dimension_";try{g="asc"==e&&"dataquerykey"==f?data_query[c][d].all():"asc"==e&&"dataqueryvalue"==f?data_query[c][d].top(1/0,"asc"):"desc"==e&&"dataquerykey"==f?data_query[c][d].all("desc"):"desc"==e&&"dataqueryvalue"==f?data_query[c][d].top(1/0):data_query[c][d].top(1/0,"asc")}catch(p){console.error("Metric ,Dimension is not created or exist")}if(m=g.length,"avg"==o[j])for(h=[],k=0;m>k;k++)h[k]={},h[k].value=g[k].value.val,h[k].key=g[k].key;else if(h=[],d.match("_dimension_")&&(data_query[c].config.dim?"*"!==data_query[c].config.dim[0]:!0)){var q,r=data_query[c].config.dim,s=r.length;for(k=0;m>k;k++)for(h[k]={},l=0;s>l;l++)"object"==typeof r[l]?(i=Object.keys(r[l])[0],h[k][i]=r[l][i](g[k])):(q=r[l].split(" AS "),q.length>1?h[k][q[1]]=g[k][q[0]]:h[k][r[l]]=g[k][r[l]])}else for(k=0;m>k;k++){h[k]={};for(i in g[k])h[k][i]=g[k][i]}return d.match("_dimension_")&&data_query[c].config.sort&&data_query[c].config.sort!=={}&&(h=h.sort(function(a,b){return a[f]-b[f]}),"desc"===e&&(h=h.reverse())),void 0!==data_query[c].config.limit&&(n=h.slice(0,data_query[c].config.limit>h.length?h.length:data_query[c].config.limit)),data_query[c].config.data_impacts&&b(a,c,n?n:h),n?n:h};return{init:a,setQuery:f,getData:g,createDimension:c,createMetric:d,applyFilter:e,dataPropagation:b}}(),Query.gql=function(){function a(a,b){var c=b.list,d=b.l,e=b.table_name;d<c.length?(b.l++,f({url:c[d],method:"DELETE",async:!0,xmlResponse:!0,headers:{"Content-type":"application/atom+xml",authorization:"Bearer "+data_query[e].config.access_token,"If-Match":"*"},onSuccess:function(a,b){},onError:function(a){console.log("error"),b.error++},callBackParams:b})):b.error&&b.failure_callback&&b.failure_callback()}function b(b,c){var d,e=[];if(b=b.feed.entry){for(response_length=b.length,d=0;d<response_length;d++)e.push(b[d].link[1].href);for(c.list=e,d=0;d<e.length;d++)c.l=d,a("",c);t("",{table_name:c.table_name,data:c.data,i:0,success_callback:c.success_callback,failure_callback:c.failure_callback})}else t("",{table_name:c.table_name,data:c.data,i:0,success_callback:c.success_callback,failure_callback:c.failure_callback})}function c(a,b){var c,e=a.entry,g=b.table_name,h=b.l,i=b.set,j=Object.keys(i);a=b.response,request='<entry xmlns="http://www.w3.org/2005/Atom" xmlns:gsx="http://schemas.google.com/spreadsheets/2006/extended"><id>'+e.id.$t+"</id><updated>"+a[h].updated.$t+'</updated><category scheme="http://schemas.google.com/spreadsheets/2006" term="http://schemas.google.com/spreadsheets/2006#list" /><title type="text">'+a[h].title.$t+'</title><content type="text">'+a[h].content.$t+'</content><link rel="self" type="application/atom+xml" href="'+a[h].link[0].href+'"/><link rel="edit" type="application/atom+xml" href="'+e.link[1].href+'"/>';for(c in a[h])c.indexOf("gsx$")>-1&&(split=c.split("$"),value=a[h][c].$t,j.indexOf(split[1])>-1&&(value=i[split[1]]),request+="<gsx:"+split[1]+">"+value+"</gsx:"+split[1]+">");request+="</entry>",b.l++,f({url:e.link[1].href,method:"PUT",async:!0,xmlResponse:!0,params:request,headers:{"Content-type":"application/atom+xml",authorization:"Bearer "+data_query[g].config.access_token},onSuccess:d,onError:function(a){b.error++},callBackParams:b})}function d(a,b){var d=b.l,e=b.table_name;a=0===d?a.feed.entry:b.response,d<a.length?a?f({url:a[d].link[0].href+"?alt=json",method:"GET",async:!0,xmlResponse:!1,headers:{"Content-type":"application/atom+xml",authorization:"Bearer "+data_query[e].config.access_token},onSuccess:c,onError:function(a){console.log(a,"ERROR"),b.error++},callBackParams:{table_name:b.table_name,set:b.set,success_callback:b.success_callback,failure_callback:b.failure_callback,response:JSON.parse(JSON.stringify(a)),l:b.l}}):console.warn("No rows updated"):b.error&&b.failure_callback?b.failure_callback():b.success_callback&&b.success_callback()}var e=function(a){var b,c,d="",e=Object.keys(a),f=e.length;for(c=0;f>c;c++)b=e[c],d+=encodeURIComponent(b)+"="+a[b]+(c!==f-1?"&":"");return d},f=function(a){a.callBackParams=a.callBackParams||"",a.xmlResponse=a.xmlResponse||!1;var b,c,d,f=new XMLHttpRequest,g=a.headers;f.onreadystatechange=function(){4===f.readyState&&(200===f.status||201===f.status?(b=a.xmlResponse?f.responseXML:JSON.parse(f.responseText),a.onSuccess(b,a.callBackParams)):(400===f.status||401===f.status)&&(b=f.statusText,console.log(a.callBackParams,"failure"),a.onError(b,a.callBackParams)))},f.open(a.method,a.url,a.async);for(d in g)f.setRequestHeader(d,g[d]);a.xmlResponse&&(f.responseType="document"),"POST"===a.method||"PUT"===a.method?(c="string"==typeof a.params?a.params:e(a.params),f.send(c)):f.send()},g=function(a,b){var c=a.refresh_token;f({url:"https://www.googleapis.com/oauth2/v4/token",method:"POST",async:!0,params:{client_id:"522064618429-he6gtt31kt4o0e0d7hp4dofr43a3hl80.apps.googleusercontent.com",client_secret:"H1B7u1_FRvfQRTPo1GYmdrEv",refresh_token:c,grant_type:"refresh_token"},headers:{"Content-type":"application/x-www-form-urlencoded"},onSuccess:b,onError:function(a){console.log(a,"ERROR")},callBackParams:a})},h=function(a){var b,c="",d="",e="",f="",g="",h="",k="",r="",s="",t="";for(b in a)switch(b){case"tab_name":d=a[b];break;case"que_name":break;case"dim":c=i(a[b]);break;case"met":r=l(a[b],a);break;case"filter":h=j(a[b]);break;case"group":g=m(a.dim);break;case"orderby":k=p(a[b]);break;case"limit":f=n(a[b]);break;case"pivot":s=o(a[b]);break;case"as":t=q(a[b])}return c&&(e+=c+" "),r&&(e+=r+" "),h&&(e+=h+" "),g&&(e+=g+" "),k&&(e+=k+" "),s&&(e+=s+" "),f&&(e+=f),t&&(e+=t),e.trim()},i=function(a){var b,c,d="select ",e=a.length;for(b=0;e>b;b++)c=a[b].split(" AS "),c.length>1&&(a[b]=c[0]);return d+=a.join(","),0===e&&(d+="*"),d},j=function(a){var b,c=a.length,d="Where ";for(b=0;c>b;b++)d+=k(a[b]),a[b].next&&(d+="And"===a[b].next?" and ":" or ");return d},k=function(a){var b="";switch(a.cond){case"Equal":b=a.col_name,b+=" = ",b+=a.val;break;case"NotEqual":b=a.col_name,b+=" != ",b+=a.val;break;case"LessThan":b=a.col_name,b+=" < ",b+=a.val;break;case"GreaterThan":b=a.col_name,b+=" > ",b+=a.val;break;case"LessThanEqual":b=a.col_name,b+=" <= ",b+=a.val;break;case"GreaterThanEqual":b=a.col_name,b+=" >= ",b+=a.val;break;case"Between":b=a.col_name,b+=" > "+a.val[0]+" and "+a.col_name+" < "+a.val[1];break;case"NotBetween":b=a.col_name,b+=" < "+a.val[0]+" and "+a.col_name+" > "+a.val[1]}return b},l=function(a,b){var c,d,e=void 0!==b.dim?", ":"select ",f=a.length,g=[];for(c=0;f>c;c++)for(d in a[c])e+=d,e+="("+a[c][d]+")",g.push(e);return g.join(",")},m=function(a){var b="group by ";return b+=a.join(",")},n=function(a){return"limit "+a},o=function(a){var b,c="pivot ",d=a.length;if(c+=a[0],d>1)for(b=1;d>b;b++)c+=", "+a[b];return c},p=function(a){var b="order by ";return b+=a},q=function(a){for(var b="label ",c=0;c<a.actual.length;c++)b+=a.actual[c]+" '"+a.alias[c]+"'",c!==a.actual.length-1&&(b+=", ");return b.trim()},r=function(a,b){var c,d,e,f;if(a.column_header)for(c=a.column_header.length,f=0;c>f;f++)d=a.column_header[f].label,e=new RegExp(d,"g"),b=b.replace(e,a.column_header[f].id);return b},s=function(a,b,c){var d=new google.visualization.Query("https://docs.google.com/spreadsheets/d/"+data_query[a].config.sheet+"/gviz/tq?gid="+data_query[a].config.sheetId);d.setQuery(b),d.send(function(a){var b=Query.utility.convertDataToJson(a.getDataTable(),"GQL");c(b)})},t=function(a,b){var c=b.i,d=b.table_name,e=b.data;if(c<e.length){b.i++;var g,h='<entry xmlns="http://www.w3.org/2005/Atom" xmlns:gsx="http://schemas.google.com/spreadsheets/2006/extended">';for(g in e[c])h+="<gsx:"+g.replace(" ","").toLowerCase()+">",h+=""+e[c][g],h+="</gsx:"+g.replace(" ","").toLowerCase()+">";h+="</entry>",f({url:"https://spreadsheets.google.com/feeds/list/"+data_query[d].config.sheet+"/"+data_query[d].config.sheetNumber+"/private/full",method:"POST",async:!0,params:h,xmlResponse:!0,headers:{"Content-type":"application/atom+xml",authorization:"Bearer "+data_query[d].config.access_token},onSuccess:t,onError:function(a,b){b.error++},callBackParams:b})}else b.error&&b.failure_callback?b.failure_callback():b.success_callback&&b.success_callback();
},u=function(a,c,d,e){f({url:"https://spreadsheets.google.com/feeds/list/"+data_query[a].config.sheet+"/"+data_query[a].config.sheetNumber+"/private/full?alt=json",method:"GET",async:!0,xmlResponse:!1,headers:{"Content-type":"application/atom+xml",authorization:"Bearer "+data_query[a].config.access_token},onSuccess:b,onError:function(a){console.log(a,"ERROR"),params.failure_callback&&params.failure_callback()},callBackParams:{table_name:a,data:c,success_callback:d,failure_callback:e}})},v=function(a,b,c,e,g){f({url:"https://spreadsheets.google.com/feeds/list/"+data_query[a].config.sheet+"/"+data_query[a].config.sheetNumber+"/private/full?alt=json&sq="+c,method:"GET",async:!0,xmlResponse:!1,headers:{"Content-type":"application/atom+xml",authorization:"Bearer "+data_query[a].config.access_token},onSuccess:d,onError:function(a){console.log(a,"ERROR"),params.failure_callback&&params.failure_callback()},callBackParams:{table_name:a,set:b,success_callback:e,failure_callback:g,l:0,error:0}})};return{getData:s,moduleForProcessingJson:h,changeToGqlJson:r,updateAllDataInSheet:u,addDataToSheet:t,updateDataInSheet:v,convertToWhere:j,reGenerateAccessToken:g}}();